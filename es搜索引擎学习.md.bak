## elasticsearch（es）
记录学习elasticsearch的笔记，基本资料来源于https://github.com/doocs/advanced-java ，推荐阅读

### elasticsearch架构
设计理念是分布式搜索引擎，底层基于lucene，分布式架构，es中存储的基本单位是索引，所有类型相同的数据都会写到这个索引中，一个索引相当于mysql里的一张表。一个index下默认一个type，type指的是映射类型，指的是具有相同类型的数据存储，但是可能存在一个index下存在多个type的情况(在elasticsearch7.X中type完全移除，移除原因是由于同一个index下多个type中名称相同的字段是由同一个lucene来支持，意味着同一个字段的类型必须相同，在此之上需要考虑一点，如果同一个索引中存储的各个实体如果只有很少或者根本没有同样的字段，这种情况会导致稀疏数据，并且会影响到Lucene的高效压缩数据的能力),一个document就代表一条数据，field就代表document中的字段。同时支持分布式存储，索引可以拆分成多个shard，每个shard存储部分数据，支持横向扩展和提升性能。具备高可用，shard有数据备份，写入primary shard，replica shard同步数据。es集群拥有多个节点，master节点处理管理事件，比如维护索引元数据，切换primary shard和replica shard的身份等。master节点宕机后会重新选举一个master节点，如果非master节点宕机，如果该节点上有primary shard，master节点会将该节点上的primary shard对应的replica shard提升为primary shard，让集群能够正常工作，在服务器恢复之后，该服务器上原来的primary shard会变为replica shard，同步宕机过程缺失的数据。具有高可用和分布式的特性。

### elasticsearch数据的处理原理

1.es写入数据
客户端选择一个node发送请求，该node就是coordinating node（协调节点），该节点对document进行路由，将该节点转发给对应的node，该node上的primary shard对数据进行处理，同时同步到replica shard节点，coordinating node如果发现primary shard和所有的replica shard都同步完成，就会返回响应结果给客户端。

2.es读取数据
主要是根据数据的doc id来查询，客户端发送请求到任意node(coordinating node),coordinating node将doc id进行哈希路由，把请求转发到对应的node，此时会使用round-robin随机轮询算法，会在primary shard和replica shard中随机选择一个，让读请求负载均衡，接受请求的node返回document给coordinate node，coordinate node在将document给客户端。

3.es检索数据
客户端将请求发送到coordinating node，node将搜索结果转发到所有的shard，将所有结果（doc id）返回给node，node节点将数据进行合并、排序、分页等操作，然后node根据doc id去各个节点上拉取实际的document数据，最终返回给客户端。

4.写入数据原理
先将数据写入内存buffer(这时候是搜索不到数据的)，同时将数据写入到translog日志文件。如果这时候buffer快满了或者到了一定时间，就会将buffer的数据refresh到一个新的segment file(磁盘文件)中，但是此时数据并不是直接写入segment file，而是写入到no cache(操作系统缓存),每隔1秒钟，es将buffer中的数据写入到新的segment file，在写入
